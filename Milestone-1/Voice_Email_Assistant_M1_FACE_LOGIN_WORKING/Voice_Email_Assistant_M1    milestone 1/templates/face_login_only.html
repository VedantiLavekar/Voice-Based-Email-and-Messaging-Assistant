<!DOCTYPE html>
<html>
<head>
    <title>Face Login</title>
</head>
<body>
<h2>Login with Face</h2>

<button type="button" onclick="loginWithFace()">Login with Face</button>

<video id="video" width="320" height="240" autoplay style="display:none;"></video>
<canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
<p id="status"></p>

<script>
async function loginWithFace() {
    const status = document.getElementById("status");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    status.innerText = "Opening camera...";

    let stream;
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
    } catch {
        status.innerText = "Camera permission denied";
        return;
    }

    video.srcObject = stream;
    video.style.display = "block";

    setTimeout(async () => {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL("image/jpeg");

        stream.getTracks().forEach(t => t.stop());
        video.style.display = "none";

        status.innerText = "Verifying face...";

        const res = await fetch("/api/face-login", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ image: imageData })
        });

        const data = await res.json();

        if (data.success) {
            status.innerText = "Login successful";
            setTimeout(() => window.location.href = "/dashboard", 1000);
        } else {
            status.innerText = data.message;
        }
    }, 2000);
}
</script>
</body>
</html>
